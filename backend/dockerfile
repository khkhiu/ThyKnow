# Use Node.js v25 as the base image (Railway compatible)
FROM node:22-slim

# Set working directory
WORKDIR /app

# Copy package files for dependency installation
COPY package*.json ./
COPY frontend/package*.json ./frontend/

# Install backend dependencies
RUN npm ci --only=production

# Install frontend dependencies
WORKDIR /app/frontend
RUN npm ci

# Switch back to app directory and copy source code
WORKDIR /app
COPY . .

# Build TypeScript backend
RUN npx tsc

# Build frontend from frontend directory
WORKDIR /app/frontend
RUN npm run build

# Return to app directory
WORKDIR /app

# Create frontend dist directory and copy built files
RUN mkdir -p dist/frontend
RUN cp -r frontend/dist/* dist/frontend/

# Clean up to reduce image size
RUN rm -rf frontend/src frontend/node_modules frontend/dist

# Expose port
EXPOSE $PORT

# Start the application
CMD ["node", "dist/src/server.js"]